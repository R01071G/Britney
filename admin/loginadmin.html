<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel de Administración</title>

<!-- 🌐 Librerías -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">

<link rel="icon" type="image/png" href="../img/icon2.png">
<link rel="stylesheet" href="../admincss/loginadmin.css">
<link rel="stylesheet" href="../css/styles.css">

</head>
<body>
  <div class="login-box animate__animated animate__fadeInUp">
    <i class="bx bxs-shield login-icon"></i>
    <h2>Área Restringida - Administrador</h2>

    <form id="loginAdminForm" novalidate>
      <input type="email" id="email" placeholder="Correo electrónico" required>
      <input type="password" id="password" placeholder="Contraseña" required>
      <button type="submit" class="btn-login">Acceder al Panel</button>
    </form>

    <div id="estado"></div>
    <p style="font-size:0.9rem; color:#d0f0ff; margin-top:15px;">
      Solo los administradores tienen acceso a esta sección. <br>
      Si no eres administrador, utiliza el botón de abajo para regresar.
    </p>
    <a href="../index.html" class="btn-volver">← Volver al inicio</a>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://phikuwjapkwmflnhekrg.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoaWt1d2phcGt3bWZsbmhla3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzQ1MzIsImV4cCI6MjA3Mzc1MDUzMn0.a1bGSecYAQG4q_IOdndOo6r76CgeEGLnoODFLemQwZc"
);

const form = document.getElementById("loginAdminForm");
const estado = document.getElementById("estado");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");

  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  let valid = true;
  [emailInput, passwordInput].forEach(input => {
    if (!input.value.trim()) {
      input.classList.add("is-invalid");
      valid = false;
    } else {
      input.classList.remove("is-invalid");
    }
  });

  if (!valid) {
    estado.innerHTML = "<span style='color:#ff6b6b;'>⚠️ Completa todos los campos.</span>";
    return;
  }

  estado.innerHTML = "<span style='color:#facc15;'>⏳ Verificando credenciales...</span>";

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    estado.innerHTML = "<span style='color:#ff6b6b;'>❌ " + error.message + "</span>";
    return;
  }

  const user = data?.user;
  const { data: perfil } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .maybeSingle();

  const rol = perfil?.role || "user";
  if (rol !== "admin") {
    estado.innerHTML = "<span style='color:#ff6b6b;'>🚫 Acceso denegado. Solo administradores.</span>";
    await supabase.auth.signOut();
    return;
  }

  estado.innerHTML = "<span style='color:#4ade80;'>✅ Bienvenido, administrador. Redirigiendo...</span>";
  setTimeout(() => window.location.href = "panel.html", 900);
});
</script>
</body>
</html>
